<!DOCTYPE html>
<html lang="en">
<head>
	<title>Mapping with D3</title>
	<meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <!--this doesn't seem to help-->
    <meta http-equiv="Access-Control-Allow-Origin" content="*"/>
	<script src="https://d3js.org/d3.v5.min.js" charset="utf-8"></script>
	<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>


</head>
<body>
	<!-- Page elements and content go here. -->


	<script>
		// Our D3 code will go here.
		var width = 960,
        height = 500;
				var albersProjection=d3.geoAlbers()
														.scale(50000)
														.rotate([73.985880,0])
														.center([0,40.693943])
														.translate([width/2,height/2])
  	var path = d3.geoPath()
								.projection(albersProjection)
    var svg = d3.select("body").append("svg")
                .attr("width", width)
                .attr("height", height);
		var proxyUrl = 'https://cors-anywhere.herokuapp.com/'
		var nyczipcode='https://data-beta-nyc-files.s3.amazonaws.com/resources/6df127b1-6d04-4bb7-b983-07402a2c3f90/f4129d9aa6dd4281bc98d0f701629b76nyczipcodetabulationareas.geojson?Signature=p9VbYePt9oJsAXR7Bb3ZidHA9YQ%3D&Expires=1588032506&AWSAccessKeyId=AKIAWM5UKMRH2KITC3QA'
	  var nyc_cases='https://raw.githubusercontent.com/ragini30/project/master/covid_cases_zip.csv'
	//	var nyc_cases="covid_cases_zip.csv"
		var covid = d3.map();
		var promises = [
										 d3.json(proxyUrl + nyczipcode),
										 d3.csv(proxyUrl + nyc_cases, function(d) { covid.set(d.ZIP_code, +d.Total_cases) })]
	 var x = d3.scaleLinear()
						 .domain([30,100,200,500,1000,2000])
						 .range([0,50,100,150,200,250]);
	 var color = d3.scaleThreshold()
					       .domain(d3.range(30, 1861))
					       .range(d3.schemeBlues[9]);
								 var color = d3.scaleThreshold()
							     .domain([30,100,200,500,1000,2000])
							     .range(d3.schemeYlGnBu[6]);
	 var g = svg.append("g")
	 						.attr("class", "key")
           		.attr("transform", "translate(400,390)");

							g.selectAll("rect")
									.data(color.range().map(function(d) {
											d = color.invertExtent(d);
											if (d[0] == null) d[0] = x.domain()[0];
											if (d[1] == null) d[1] = x.domain()[1];
											console.log(d)
											return d;
									}))
									.enter().append("rect")
									.attr("height", 8)
									.attr("x", function(d,i) { return 50*i; })
									.attr("y", 0)
									.attr("width", function(d) { return 50; })
									.attr("fill", function(d) { return color(d[0]); });

							g.append("text")
									.attr("class", "caption")
									.attr("x", x.range()[0])
									.attr("y",0)
									.attr("fill", "#000")
									.attr("text-anchor", "start")
									.attr("font-weight", "bold")
									.attr("font-size",8)
									.text("No. of Twitter 311 Requests (in Log Scale)");


							 console.log(color.range())
							g.call(d3.axisBottom(x)
							.scale(x)
							.tickSize(13)
							.ticks()
							.tickFormat(function(x, i) { return i ? x : x ; })
							//.tickArguments([8]))
							.tickValues(color.domain()))
							.select(".domain")
							.remove();
	Promise.all(promises).then(ready)



					 function ready([us]) {
						 console.log(color(covid.get(10005)))
						 console.log(us)
	            svg.append("g")
	                .selectAll("path")
	                .data(us.features)
	                .enter()
									.append("path")
									//.attr("stroke","#333")
	                .attr("fill", function(d) { if (color(covid.get(+d.properties.postalCode))==undefined)
										return "white"
										else
										return color(covid.get(d.properties.postalCode)) })
	                // .style("fill","white") REMOVE THIS LINE
	                 .attr("d", path)
	        }



	</script>
</body>
</html>
